<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Connected Train</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body class="container py-5">

    <h2 class="mb-4">Deployed VKG Connection</h2>

    <div id="vkg-status-alert" class="alert alert-info" role="alert">
        ⏳ Connecting VKG container...
    </div>

    <div id="vkg-query-status-container" class="mt-3">
        </div>

    <ul class="list-group">
        <li class="list-group-item d-flex justify-content-between align-items-start flex-wrap">
            <div class="me-auto">
                <strong>VKG Container:</strong> {{ ontop_name }}<br />
                <strong>Used OBDA configuration:</strong> {{obda_name}}<br />
                <strong>Database Connection:</strong> {{ db_name }}<br />
                <strong>Train Container:</strong> {{ train.name }}<br />
                <small class="text-muted">ID: {{ train.id }}</small>

            </div>

            <div class="d-flex gap-2 flex-wrap ms-auto">
                <a href="{{ url_for('view_logs_deployment', container_id=train.id) }}" class="btn btn-sm btn-outline-info">View Logs</a>
                <form action="{{ url_for('remove_deploy') }}" method="POST">
                    <input type="hidden" name="to_remove" value="{{ ontop_name }}|{{ train.id }}">
                    <button type="submit" class="btn btn-sm btn-outline-danger">Remove</button>
                </form>
            </div>
        </li>
    </ul>

    <div class="mt-4 d-flex gap-2 flex-wrap">
        <a href="{{ url_for('index') }}" class="btn btn-outline-primary">Back to Start</a>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const vkgStatusAlert = document.getElementById('vkg-status-alert');
            const vkgQueryStatusContainer = document.getElementById('vkg-query-status-container');
            const ontopName = "{{ ontop_name }}";

            let vkgStatusInterval;
            let vkgQueryStatusInterval;

            function checkVkgStatus() {
                fetch(`/check_vkg_connection_status/${ontopName}`)
                    .then(response => response.json())
                    .then(data => {
                        vkgStatusAlert.className = 'alert';
                        let alertMessage = data.message;

                        if (data.status === 'connected') {
                            vkgStatusAlert.classList.add('alert-success');
                            clearInterval(vkgStatusInterval); // Stop polling VKG connection status
                            // ⭐ Start checking VKG Query status ONLY after VKG is connected
                            if (!vkgQueryStatusInterval) { // Prevent multiple intervals from starting
                                vkgQueryStatusInterval = setInterval(checkVkgQueryStatus, 3000);
                                checkVkgQueryStatus(); // Initial call for query status
                            }
                        } else if (data.status === 'error') {
                            vkgStatusAlert.classList.add('alert-danger');
                            alertMessage += `<br><a href="{{ url_for('view_ontop_logs', ontop_name=ontop_name) }}" class="btn btn-sm btn-primary mt-2">View VKG container Logs</a>`;
                            clearInterval(vkgStatusInterval); // Stop polling on error
                            clearInterval(vkgQueryStatusInterval); // Also stop query status if it somehow started
                        } else {
                            vkgStatusAlert.classList.add('alert-info');
                        }
                        vkgStatusAlert.innerHTML = alertMessage;
                    })
                    .catch(error => {
                        console.error('Error fetching VKG connection status:', error);
                        vkgStatusAlert.className = 'alert alert-danger';
                        vkgStatusAlert.innerHTML = `Error checking VKG connection status.<br><a href="{{ url_for('view_ontop_logs', ontop_name=ontop_name) }}" class="btn btn-sm btn-primary mt-2">View VKG container Logs</a>`;
                        clearInterval(vkgStatusInterval); // Stop polling on fetch error
                        clearInterval(vkgQueryStatusInterval); // Also stop query status
                    });
            }

            function checkVkgQueryStatus() {
                fetch(`/check_vkg_query/${ontopName}`)
                    .then(response => response.json())
                    .then(data => {
                        vkgQueryStatusContainer.innerHTML = '';

                        if (data.status === 'error') {
                            const errorAlert = document.createElement('div');
                            errorAlert.className = 'alert alert-danger';
                            let alertMessage = data.message;
                            alertMessage += `<br><a href="{{ url_for('view_ontop_logs', ontop_name=ontop_name) }}" class="btn btn-sm btn-primary mt-2">View VKG container Logs</a>`;
                            errorAlert.innerHTML = alertMessage;
                            vkgQueryStatusContainer.appendChild(errorAlert);
                            clearInterval(vkgQueryStatusInterval); // Stop polling query if an error is found
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching VKG query status:', error);
                        vkgQueryStatusContainer.innerHTML = '';
                        const errorAlert = document.createElement('div');
                        errorAlert.className = 'alert alert-danger';
                        errorAlert.innerHTML = `Error checking VKG query status.<br><a href="{{ url_for('view_ontop_logs', ontop_name=ontop_name) }}" class="btn btn-sm btn-primary mt-2">View VKG container logs Logs</a>`;
                        vkgQueryStatusContainer.appendChild(errorAlert);
                        clearInterval(vkgQueryStatusInterval); // Stop polling on fetch error
                    });
            }

            // Initial call for VKG connection status
            checkVkgStatus();
            // Start polling for VKG connection status
            vkgStatusInterval = setInterval(checkVkgStatus, 3000);
        });
    </script>

</body>
</html>