<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Connected Train</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body class="container py-5">

    <h2 class="mb-4">Deployed VKG Connection</h2>

    <div id="vkg-status-alert" class="alert alert-info" role="alert">
        ‚è≥ Connecting VKG container...
    </div>

    <div id="vkg-query-status-container" class="mt-3">
        </div>

    <ul class="list-group">
        <li class="list-group-item d-flex justify-content-between align-items-start flex-wrap">
            <div class="me-auto">
                <strong>VKG Container:</strong> {{ ontop_name }}<br />
                <strong>Train Container:</strong> {{ train.name }}<br />
                <small class="text-muted">ID: {{ train.id }}</small>
            </div>

            <div class="d-flex gap-2 flex-wrap ms-auto">
                <a href="{{ url_for('view_logs_deployment', container_id=train.id) }}" class="btn btn-sm btn-outline-info">View Logs</a>
                <form action="{{ url_for('remove_combination') }}" method="POST">
                    <input type="hidden" name="to_remove" value="{{ ontop_name }}|{{ train.id }}">
                    <button type="submit" class="btn btn-sm btn-outline-danger">Remove</button>
                </form>
            </div>
        </li>
    </ul>

    <div class="mt-4 d-flex gap-2 flex-wrap">
        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">Back to Start</a>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const vkgStatusAlert = document.getElementById('vkg-status-alert');
            const vkgQueryStatusContainer = document.getElementById('vkg-query-status-container'); // Get the new container
            const ontopName = "{{ ontop_name }}"; // Get ontop_name from Flask context

            function checkVkgStatus() {
                fetch(`/check_vkg_connection_status/${ontopName}`)
                    .then(response => response.json())
                    .then(data => {
                        vkgStatusAlert.className = 'alert'; // Reset classes
                        let alertMessage = data.message;

                        if (data.status === 'connected') {
                            vkgStatusAlert.classList.add('alert-success');
                            clearInterval(vkgStatusInterval); // Stop polling on success
                        } else if (data.status === 'error') {
                            vkgStatusAlert.classList.add('alert-danger');
                            // Append the button HTML directly to the alert message
                            alertMessage += `<br><a href="{{ url_for('view_ontop_logs', ontop_name=ontop_name) }}" class="btn btn-sm btn-primary mt-2">View Ontop Logs</a>`;
                            clearInterval(vkgStatusInterval); // Stop polling on error
                        } else {
                            vkgStatusAlert.classList.add('alert-info');
                        }
                        vkgStatusAlert.innerHTML = alertMessage; // Set innerHTML to include potentially the button

                    })
                    .catch(error => {
                        console.error('Error fetching VKG connection status:', error);
                        vkgStatusAlert.className = 'alert alert-danger';
                        // Provide a generic error message and show the button
                        vkgStatusAlert.innerHTML = `Error checking VKG connection status.<br><a href="{{ url_for('view_ontop_logs', ontop_name=ontop_name) }}" class="btn btn-sm btn-primary mt-2">View Ontop Logs</a>`;
                        clearInterval(vkgStatusInterval); // Stop polling on fetch error
                    });
            }

            // New function to check VKG Query status
            function checkVkgQueryStatus() {
                fetch(`/check_vkg_query/${ontopName}`)
                    .then(response => response.json())
                    .then(data => {
                        // Clear previous alerts from the container
                        vkgQueryStatusContainer.innerHTML = '';

                        if (data.status === 'error') {
                            const errorAlert = document.createElement('div');
                            errorAlert.className = 'alert alert-danger';
                            let alertMessage = data.message;
                            alertMessage += `<br><a href="{{ url_for('view_ontop_logs', ontop_name=ontop_name) }}" class="btn btn-sm btn-primary mt-2">View Ontop Logs</a>`;
                            errorAlert.innerHTML = alertMessage;
                            vkgQueryStatusContainer.appendChild(errorAlert);
                        }
                        // If data.status is 'running' (no error), nothing is appended, so no alert is shown.
                    })
                    .catch(error => {
                        console.error('Error fetching VKG query status:', error);
                        vkgQueryStatusContainer.innerHTML = ''; // Clear existing alerts
                        const errorAlert = document.createElement('div');
                        errorAlert.className = 'alert alert-danger';
                        errorAlert.innerHTML = `Error checking VKG query status.<br><a href="{{ url_for('view_ontop_logs', ontop_name=ontop_name) }}" class="btn btn-sm btn-primary mt-2">View Ontop Logs</a>`;
                        vkgQueryStatusContainer.appendChild(errorAlert);
                    });
            }

            // Poll every 3 seconds (adjust as needed) for VKG Connection
            const vkgStatusInterval = setInterval(checkVkgStatus, 3000);
            // Poll every 3 seconds (adjust as needed) for VKG Query
            const vkgQueryStatusInterval = setInterval(checkVkgQueryStatus, 3000);


            // Initial checks when the page loads
            checkVkgStatus();
            checkVkgQueryStatus();
        });
    </script>

</body>
</html>